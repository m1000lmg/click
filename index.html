<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dot Dodge with Leaderboard</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #111;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: sans-serif;
    }

    canvas {
      background: #222;
      border: 2px solid #0f0;
    }

    #restartBtn {
      margin-top: 10px;
      padding: 0.5rem 1rem;
      background: #0f0;
      border: none;
      font-weight: bold;
      cursor: pointer;
      display: none;
    }

    #leaderboard {
      margin-top: 20px;
      color: #0f0;
      font-size: 1rem;
    }

    #leaderboard h3 {
      margin-bottom: 0.5rem;
    }

    #leaderboard ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #leaderboard li {
      margin: 2px 0;
    }
  </style>
</head>
<body>

<canvas id="gameCanvas" width="400" height="600"></canvas>
<button id="restartBtn">Restart</button>

<div id="leaderboard">
  <h3>üèÜ Leaderboard (Top 5)</h3>
  <ul id="scoresList">
    <li>Loading...</li>
  </ul>
</div>

<!-- Firebase -->
<script type="module">
  // Import Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // Your config
  const firebaseConfig = {
    apiKey: "AIzaSyA7IGIzhaH7F2-P-gZ3A7ARUfMFE7s4iBM",
    authDomain: "customs-market.firebaseapp.com",
    projectId: "customs-market",
    storageBucket: "customs-market.appspot.com",
    messagingSenderId: "242049210602",
    appId: "1:242049210602:web:9e87db4ca3ecdb942ddf93"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const restartBtn = document.getElementById('restartBtn');
  const scoresList = document.getElementById('scoresList');

  let player = { x: 180, y: 550, size: 20, speed: 5 };
  let enemies = [];
  let keys = {};
  let gameOver = false;
  let spawnTimer = 0;
  let score = 0;
  let survivalStartTime = null;

  document.addEventListener('keydown', e => keys[e.key] = true);
  document.addEventListener('keyup', e => keys[e.key] = false);
  restartBtn.addEventListener('click', restartGame);

  async function updateLeaderboard() {
    scoresList.innerHTML = '<li>Loading...</li>';
    const scoresRef = collection(db, "leaderboard");
    const topScores = await getDocs(query(scoresRef, orderBy("score", "desc"), limit(5)));

    scoresList.innerHTML = "";
    topScores.forEach(doc => {
      const data = doc.data();
      scoresList.innerHTML += `<li>${data.name}: ${data.score}s</li>`;
    });
  }

  async function submitScore(score) {
    const name = prompt("Enter your name for the leaderboard:", "Player" + Math.floor(Math.random() * 9999));
    if (!name) return;

    await addDoc(collection(db, "leaderboard"), {
      name,
      score,
      timestamp: Date.now()
    });

    updateLeaderboard();
  }

  function drawPlayer() {
    ctx.fillStyle = '#00f';
    ctx.fillRect(player.x, player.y, player.size, player.size);
  }

  function drawEnemies() {
    ctx.fillStyle = '#f00';
    enemies.forEach(enemy => {
      ctx.fillRect(enemy.x, enemy.y, enemy.size, enemy.size);
    });
  }

  function updateEnemies() {
    for (let enemy of enemies) {
      enemy.y += enemy.speed;
    }

    enemies = enemies.filter(e => e.y < canvas.height);
  }

  function spawnEnemy() {
    const size = 20;
    const x = Math.random() * (canvas.width - size);
    enemies.push({ x, y: -size, size, speed: 3 + Math.random() * 2 });
  }

  function checkCollision(a, b) {
    return (
      a.x < b.x + b.size &&
      a.x + a.size > b.x &&
      a.y < b.y + b.size &&
      a.y + a.size > b.y
    );
  }

  function update() {
    if (gameOver) return;

    const now = Date.now();
    score = Math.floor((now - survivalStartTime) / 1000);

    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Move player
    if (keys['ArrowLeft']) player.x -= player.speed;
    if (keys['ArrowRight']) player.x += player.speed;
    player.x = Math.max(0, Math.min(player.x, canvas.width - player.size));

    // Update game objects
    drawPlayer();
    drawEnemies();
    updateEnemies();

    // Spawn enemies
    spawnTimer++;
    if (spawnTimer > 30) {
      spawnEnemy();
      spawnTimer = 0;
    }

    // Collision check
    for (let enemy of enemies) {
      if (checkCollision(player, enemy)) {
        endGame();
        return;
      }
    }

    requestAnimationFrame(update);
  }

  function endGame() {
    gameOver = true;
    ctx.fillStyle = '#fff';
    ctx.font = '30px sans-serif';
    ctx.fillText(`GAME OVER`, 100, 300);
    ctx.fillText(`Survived: ${score}s`, 100, 340);
    restartBtn.style.display = 'block';
    submitScore(score);
  }

  function restartGame() {
    player.x = 180;
    enemies = [];
    gameOver = false;
    restartBtn.style.display = 'none';
    score = 0;
    survivalStartTime = Date.now();
    requestAnimationFrame(update);
  }

  // Start game
  survivalStartTime = Date.now();
  requestAnimationFrame(update);
  updateLeaderboard();
</script>

</body>
</html>
